{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "publisherEmail": {
        "type": "string",
        "minLength": 1,
        "metadata": {
          "description": "The email address of the owner of the service"
        }
      },
      "publisherName": {
        "type": "string",
        "minLength": 1,
        "metadata": {
          "description": "The name of the owner of the service"
        }
      },
      "sku": {
        "type": "string",
        "allowedValues": [
          "Developer",
          "Standard",
          "Premium"
        ],
        "defaultValue": "Developer",
        "metadata": {
          "description": "The pricing tier of this API Management service"
        }
      },
      "skuCount": {
        "type": "string",
        "allowedValues": [
          "1",
          "2"
        ],
        "defaultValue": "1",
        "metadata": {
          "description": "The instance size of this API Management service."
        }
      },
      "location": {
        "type": "string",
        "defaultValue": "[resourceGroup().location]",
        "metadata": {
          "description": "Location for all resources."
        }
      },
      "environmentName":{
        "type": "string",
        "metadata": {
        "description": "Environment to be deployed in to."
        }
      },
      "virtualNetworkType":{
        "type": "string",
        "defaultValue": "External",
        "allowedValues": [
          "Internal",
          "External"
        ]
      },
      "oAuthDisplayName":{
        "type": "string"
      }, 
      "oAuthDescription" :{
        "type": "string",
        "defaultValue": null
      },
      "oAuthClientRegistrationEndpoint":{
        "type": "string",
        "defaultValue": null
      },
      "oAuthGrantTypes":{
        "type": "array",
        "defaultValue": "authorizationCode",
        "allowedValues": [
          "authorizationCode",
          "implicit",
          "resourceOwnerPassword",
          "clientCredentials"
        ]
      },
      "oAuthEndpointUrl":{
        "type": "string"
      }, 
      "oAuthRequestMethod":{
        "type": "array",
        "defaultValue": "GET",
        "allowedValues": [
          "GET",
          "POST"
        ]
      },
      "oAuthTokenEndpointUri":{
        "type": "string"
      },   
      "oAuthClientAuthenticationMethod":{
        "type": "array",
        "defaultValue": "Basic",
        "allowedValues": [
          "Basic",
          "Body"
        ]
      },           
      "oAuthTokenSendingMethod":{
        "type": "array",
        "defaultValue": "authorizationHeader",
        "allowedValues": [
          "authorizationHeader",
          "query"
        ]
      },
      "oAuthClientId":{
        "type": "string"
      },
      "oAuthClientSecret":{
        "type": "string"
      },
      "oAuthResourceOwner":{
        "type": "string",
        "defaultValue": null
      },
      "oAuthResourceOwnerPassword":{
        "type": "string",
        "defaultValue": null
      },
      "oAuthDefaultScope":{
        "type": "string",
        "defaultValue": null
      },
      "oAuthSupportState":{
        "type": "bool",
        "defaultValue": false
      },
      "branch":{
        "type": "string"
      },
      "managedBy":{
        "type": "string"
      },
      "solutionOwner":{
        "type": "string"
      },
      "activityName":{
        "type": "string"
      },
      "dataClassification":{
        "type": "string"
      },
      "automation":{
        "type": "string"
      },
      "costCentre":{
        "type": "string"
      },
      "environment":{
        "type": "string"
      },
      "criticality":{
        "type": "string"
      },
      "shortName":{
        "type": "string",
        "metadata": {
          "description": "Environment short nme used for resource group allocation"
          }
      }
    },
    "variables": { 
      "apiManagementServiceName": "[concat('core-api-mgmt-',parameters('environmentName'))]",
      "apiManagementSubnet": "[concat('core-api-mgmt-',parameters('environmentName'))]",
      "VirtualNetworkResourceGroup" : "[concat('core-infra-',parameters('shortName'))]",
      "VirtualNetworkName" : "[concat('core-infra-vnet-',parameters('shortName'))]",
      "VirtualNetworkSubnetName" : "[concat('core-infra-subnet-apimgmt-',parameters('shortName'))]",
      "SubnetResourceId": "[resourceId(variables('VirtualNetworkResourceGroup'),'Microsoft.Network/virtualNetworks/subnets',variables('VirtualNetworkName'),variables('VirtualNetworkSubnetName'))]",
      "AuthorizationServerName": "[concat(variables('apiManagementServiceName'), '/idam-aat')]"
    },
    "resources": [
      {
        "apiVersion": "2017-03-01",
        "name": "[variables('apiManagementServiceName')]",
        "type": "Microsoft.ApiManagement/service",
        "location": "[parameters('location')]",
        "tags" : {
          "EnvironmentName": "[parameters('environmentName')]",
          "Branch":"[parameters('branch')]",
          "managedBy":"[parameters('managedBy')]",
          "solutionOwner": "[parameters('solutionOwner')]",
          "activityName": "[parameters('activityName')]",
          "dataClassification":"[parameters('dataClassification')]",
          "automation": "[parameters('automation')]",
          "costCentre":"[parameters('costCentre')]",
          "environment": "[parameters('environment')]",
          "criticality": "[parameters('criticality')]"
        },
        "sku": {
          "name": "[parameters('sku')]",
          "capacity": "[parameters('skuCount')]"
        },
        "properties": {
          "publisherEmail": "[parameters('publisherEmail')]",
          "publisherName": "[parameters('publisherName')]",
          "virtualNetworkType": "[parameters('virtualNetworkType')]",
          "virtualNetworkConfiguration": {
            "subnetResourceId": "[variables('SubnetResourceId')]"
          }
        }
      },
      {
        "name": "[variables('AuthorizationServerName')]",
        "type": "Microsoft.ApiManagement/service/authorizationServers",
        "apiVersion": "2019-01-01",
        "dependsOn": [
          "[resourceId('Microsoft.ApiManagement/service', variables('apiManagementServiceName'))]"
        ],
        "properties": {
              "description": "[parameters('oAuthDescription')]",
              "authorizationMethods": "[parameters('oAuthRequestMethod')]",
              "clientAuthenticationMethod": "[parameters('oAuthClientAuthenticationMethod')]",
              "tokenEndpoint": "[parameters('oAuthTokenEndpointUri')]",
              "supportState": "[parameters('oAuthSupportState')]",
              "defaultScope": "[parameters('oAuthDefaultScope')]",
              "bearerTokenSendingMethods": "[parameters('oAuthTokenSendingMethod')]",
              "clientSecret": "[parameters('oAuthClientSecret')]",
              "resourceOwnerUsername": "[parameters('oAuthResourceOwner')]", 
              "resourceOwnerPassword": "[parameters('oAuthResourceOwnerPassword')]",
              "displayName": "[parameters('oAuthDisplayName')]",
              "clientRegistrationEndpoint": "[parameters('oAuthClientRegistrationEndpoint')]",
              "authorizationEndpoint": "[parameters('oAuthEndpointUrl')]",
              "grantTypes": "[parameters('oAuthGrantTypes')]",
              "clientId": "[parameters('oAuthClientId')]"
        }
      }
    ]
  }
